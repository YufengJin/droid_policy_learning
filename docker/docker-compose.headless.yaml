services:
  droid-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: droid-policy:latest
    container_name: droid-dev-headless
    restart: unless-stopped
    tty: true
    stdin_open: true

    environment:
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # 禁用 Open VSX，改用官方 Marketplace，避免 sigzip 校验失败导致 debugger 等扩展无法安装
      - OVSX_REGISTRY_URL=

    network_mode: host
    ipc: host
    pid: host

    volumes:
      - ..:/workspace/droid_policy_learning
      - /home/yjin/localdisk/droid/:/workspace/datasets/droid:ro
      - /home/yjin/localdisk/robocasa/:/workspace/datasets/robocasa:ro
      - ${HOME}/.cache/huggingface:/root/.cache/huggingface
      - /home/yjin/repos/cosmos-policy/:/workspace/cosmos-policy:ro
      - /home/yjin/repos/robocasa/:/workspace/robocasa:ro

    command: tail -f /dev/null

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    ulimits:
      nofile: { soft: 65536, hard: 65536 }
      nproc: 65536
      memlock: -1
      stack: 67108864
