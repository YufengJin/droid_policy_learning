Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04

%labels
    Author Droid_Dev
    Version 1.8
    Description Droid Policy Learning (def template style)

%files
    apptainer/requirements-apptainer.txt /requirements.txt

%environment
    export DEBIAN_FRONTEND=noninteractive
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH=/opt/conda/envs/droid_env/bin:/opt/conda/bin:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export CONDA_DEFAULT_ENV=droid_env
    export HOME=/root
    export HF_HOME=/root/.cache/huggingface

%post
    export DEBIAN_FRONTEND=noninteractive
    export MAMBA_ROOT_PREFIX=/opt/conda
    export ENV_NAME=droid_env

    # 1. System dependencies
    apt-get update -y
    apt-get install -y \
        curl wget tar procps bzip2 ca-certificates git build-essential cmake unzip ffmpeg \
        libgl1-mesa-glx libglib2.0-0 vim tzdata
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # 2. Install Micromamba (same as docker/Dockerfile)
    mkdir -p /usr/local/bin
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | \
        tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba
    chmod +x /usr/local/bin/micromamba
    export PATH=/usr/local/bin:$PATH

    # 3. Create conda environment
    micromamba create -y -n $ENV_NAME python=3.10.* -c conda-forge
    micromamba clean -a -y

    # 4. Install pip dependencies (use env's pip via PATH)
    export PATH=/opt/conda/envs/$ENV_NAME/bin:$PATH

    pip install --upgrade pip

    # PyTorch & JAX (CUDA) - must install before requirements.txt
    pip install torch==2.0.1+cu118 torchvision==0.15.2+cu118 \
        --extra-index-url https://download.pytorch.org/whl/cu118
    pip install --upgrade "jax[cuda11_pip]==0.4.20" \
        -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    # Install from requirements.txt
    pip install -r /requirements.txt

    # dlimp (git)
    pip install "dlimp @ git+https://github.com/kvablack/dlimp@5edaa4691567873d495633f2708982b42edf1972"

    # egl_probe (needs --no-build-isolation)
    export CMAKE_POLICY_VERSION_MINIMUM=3.5
    pip install --no-build-isolation 'egl_probe>=1.0.1'

    # 5. Octo
    mkdir -p /opt/third_party && cd /opt/third_party
    git clone https://github.com/octo-models/octo.git
    cd octo && git checkout 85b83fc19657ab407a7f56558a5384ae56fe453b
    pip install -e /opt/third_party/octo

    # 6. Robomimic
    cd /opt/third_party
    git clone https://github.com/ARISE-Initiative/robomimic.git
    cd robomimic
    pip install --no-build-isolation -e .

    # Optional: clean up
    micromamba clean -a -y

    # 7. Mount points
    mkdir -p /workspace/droid_policy_learning
    mkdir -p /workspace/datasets/droid
    mkdir -p /workspace/datasets/robocasa
    mkdir -p /root/.cache/huggingface

    # bash.bashrc for apptainer shell
    cat >> /etc/bash.bashrc << 'EOF'
export MAMBA_ROOT_PREFIX=/opt/conda
if [ -x "/usr/local/bin/micromamba" ]; then
    eval "$(/usr/local/bin/micromamba shell hook --shell bash)"
    micromamba activate droid_env
fi
EOF

%runscript
    if [ -f "/workspace/droid_policy_learning/apptainer/entrypoint.sh" ]; then
        exec /workspace/droid_policy_learning/apptainer/entrypoint.sh "$@"
    else
        export MAMBA_ROOT_PREFIX=/opt/conda
        eval "$(/usr/local/bin/micromamba shell hook --shell bash)"
        micromamba activate droid_env
        exec "$@"
    fi
